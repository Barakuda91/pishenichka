<!DOCTYPE html>
<html>
<head>
    <title>MY CALCULATOR</title>
    <link href="https://cdn.jsdelivr.net/npm/bootstrap@5.1.3/dist/css/bootstrap.min.css" rel="stylesheet" integrity="sha384-1BmE4kWBq78iYhFldvKuhfTAU6auU8tT94WrHftjDbrCEXSU1oBoqyl2QvZ6jIW3" crossorigin="anonymous">
    <script src="https://cdn.jsdelivr.net/npm/vue@2.6.14/dist/vue.js"></script>
    <script src="https://cdn.jsdelivr.net/npm/bootstrap@5.1.3/dist/js/bootstrap.bundle.min.js" integrity="sha384-ka7Sk0Gln4gmtz2MlQnikT1wXgYsOg+OMhuP+IlRH9sENBO0LRn5q+8nbTov4+1p" crossorigin="anonymous"></script>
    <link href="/style/style.css" rel="stylesheet">
</head>
<body>
<div class="container" id="app">
    <div class="row">
        <div class="col-sm-2">
            <span class="fw-bold">{{ day }} день {{ year }} г</span> /
        </div>
        <div class="col-sm-3">
            Текущая температура: <span class="fw-bold">{{ temp }} град</span> /
        </div>
        <div class="col-sm-2">
            Баланс: <span class="fw-bold">{{ balance.toFixed(0) }}</span>
        </div>
        <div class="col-sm-2">
            <button v-on:click="update" class="btn btn-sm btn-outline-primary w-100 mb-1">обновить статус</button>
        </div>
    </div>
    <div class="row">
        <div class="col-sm-3">
            <ul class="list-unstyled mt-3 mb-4">
                <li>
                    <button
                            @click="additional_tab = additional_tab === 'fields' ? null : 'fields'; update_fields_values();"
                            v-bind:class="additional_tab === 'fields' ? 'btn-primary' : 'btn-outline-primary'"
                            class="btn btn-sm w-100 mb-1"
                    >мои поля</button>
                </li>
                <li>
                    <button
                            v-on:click="additional_tab = additional_tab === 'warehouse' ? null : 'warehouse'"
                            v-bind:class="additional_tab === 'warehouse' ? 'btn-primary' : 'btn-outline-primary'"
                            class="btn btn-sm btn-outline-primary w-100 mb-1"
                    >склад</button>
                </li>
                <li>
                    <button
                            v-on:click="additional_tab = additional_tab === 'garage' ? null : 'garage'"
                            v-bind:class="additional_tab === 'garage' ? 'btn-primary' : 'btn-outline-primary'"
                            class="btn btn-sm btn-outline-primary w-100 mb-1"
                    >техника</button>
                </li>
                <li>
                    <button
                            v-on:click="additional_tab = additional_tab === 'shop' ? null : 'shop'"
                            v-bind:class = "additional_tab === 'shop' ? 'btn-primary' : 'btn-outline-primary'"
                            class="btn btn-sm btn-outline-primary w-100 mb-1"
                    >магазин</button>
                </li>
            </ul>
        </div>
        <div class="col-sm-6">
            <div v-show="additional_tab === 'warehouse'">
                <div class="card text-center">
                    <div class="card-header">
                        <ul class="nav nav-tabs card-header-tabs">
                            <li class="nav-item">
                                <button class="nav-link" aria-current="true" href="#"
                                        v-bind:class="additional_warehouse_tab === 'harvest' ? 'active' : ''"
                                        v-on:click="additional_warehouse_tab = additional_shop_tab === 'harvest' ? null : 'harvest'"
                                >урожай</button>
                            </li>
                            <li class="nav-item">
                                <button class="nav-link" href="#"
                                        v-bind:class="additional_warehouse_tab === 'seeds' ? 'active' : ''"
                                        v-on:click="additional_warehouse_tab = additional_warehouse_tab === 'seeds' ? null : 'seeds'"
                                >семена</button>
                            </li>
                        </ul>
                    </div>

                    <div class="card-body" v-show="additional_warehouse_tab === 'seeds'">
                        <div v-for="(quantity, seedType) in user.warehouse.seeds">
                            <div class="row">
                                <div class="col-sm-4">{{ _(seedType)  }}</div>
                                <div class="col-sm-4">{{ quantity.toFixed(0) }}</div>
                            </div>
                        </div>
                    </div>

                    <div class="card-body" v-show="additional_warehouse_tab === 'harvest'">
                        <div v-for="(quantity, seedType) in user.warehouse.harvest">
                            <div class="row">
                                <div class="col-sm-4">{{ _(seedType) }}</div>
                                <div class="col-sm-4">{{ quantity.toFixed(0) }}</div>
                                <div class="col-sm-4">
                                    <button class="btn btn-sm btn-success mb-1" @click="sell_harvest(seedType);">продать</button>
                                </div>
                            </div>
                        </div>
                    </div>
                </div>
            </div>

            <div v-show="additional_tab === 'garage'">
            </div>

            <div v-show="additional_tab === 'shop'">
                <div class="card text-center">
                    <div class="card-header">
                        <ul class="nav nav-tabs card-header-tabs">
                            <li class="nav-item">
                                <button class="nav-link" aria-current="true" href="#"
                                        v-bind:class="additional_shop_tab === 'fields' ? 'active' : ''"
                                        @click="additional_shop_tab = additional_shop_tab === 'fields' ? null : 'fields'"
                                >поля</button>
                            </li>
                            <li class="nav-item">
                                <button class="nav-link" href="#"
                                        v-bind:class="additional_shop_tab === 'seeds' ? 'active' : ''"
                                        v-on:click="additional_shop_tab = additional_shop_tab === 'seeds' ? null : 'seeds'"
                                >семена</button>
                            </li>
                            <li class="nav-item">
                                <button class="nav-link" href="#"
                                        v-bind:class="additional_shop_tab === 'technics' ? 'active' : ''"
                                        v-on:click="additional_shop_tab = additional_shop_tab === 'technics' ? null : 'technics'"
                                >техника</button>
                            </li>
                        </ul>
                    </div>

                    <div class="card-body" v-show="additional_shop_tab === 'seeds'">
                        <div v-for="(seed, index) in entities.seeds">
                            <div class="row">
                                <div class="col-sm-3">{{ seed.name }}</div>
                                <div class="col-sm-2">
                                    <input class="form-control form-control-sm" v-model="seeds_shop[index]" type="number" min="1" value="1" name="cols">
                                </div>
                                <div class="col-sm-4">
                                    <button class="btn btn-sm btn-success mb-1" @click="buy_seeds(seed.type, seeds_shop[index]); seeds_shop[index] = null">купить {{ seeds_shop[index] ? seed.salePrice * seeds_shop[index] : 0}} </button>
                                </div>
                            </div>
                        </div>
                    </div>

                    <div class="card-body" v-show="additional_shop_tab === 'fields'">
                        <div v-for="(item, index) in entities.fields">
                            <div class="row" v-show="!item.owner">
                                <div class="col-sm-3">размер {{ item.size }}</div>
                                <div class="col-sm-5">
                                    <button class="btn btn-sm btn-success mb-1" v-on:click="rent_field(index)">арендовать {{ item.rentPrice }} / год </button>
                                </div>
                                <div class="col-sm-4">
                                    <button class="btn btn-sm btn-success mb-1">купить {{ item.salePrice }} </button>
                                </div>
                            </div>
                        </div>
                    </div>

                    <div class="card-body" v-show="additional_shop_tab === 'technics'">
                        <div v-for="item in entities.seeds">
                            <div class="row">

                            </div>
                        </div>
                    </div>
                </div>
            </div>

            <div v-show="additional_tab === 'fields'">
                <div class="row">
                    <div v-for="(field, id) in entities.fields" class="col-sm-6" v-if="field.owner === user._id">
                        <div class="card">
                            <div class="card-body">
                                <h5 class="card-title">{{ field.size }}га <span v-if="field.crop"> [ {{ field.crop.currentStateText }} ]</span></h5>
                                <ul class="list-unstyled mt-3 mb-4">
                                    <li>
                                        Засеяно: <span class="fw-bold"> {{ field.crop ? field.crop.name : 'пусто' }}</span>
                                    </li>
                                    <li v-show="field.crop" >
                                        Состояние роста: <span class="fw-bold">{{ field.crop ? field.crop.currentState.toFixed(0) : 0 }}%</span>
                                    </li>
                                    <li v-show="field.crop" >
                                        Урожая: <span class="fw-bold">{{ field.crop ? (field.crop.currentHarvest * field.filed).toFixed(0) : 0 }}</span>
                                    </li>
                                    <li v-show="!field.crop">
                                        <div class="input-group mb-3">
                                            <select class="form-select" aria-label="Default select example" v-model="sow_field_type[id]" class="dropdown-menu" style="width: 115px;">
                                                <option value="wheat">{{ _('wheat')}}</option>
                                                <option value="barley">{{ _('barley')}}</option>
                                            </select>
                                            <input type="number" min="1" v-bind:max="field.size" v-model="sow_field_quantity[id]" class="form-control" placeholder="" aria-label="Example text with button addon" aria-describedby="button-addon1">
                                        </div>
                                    </li>
                                </ul>

                                <a href="#" v-show="!field.crop" class="btn btn-primary btn-sm" v-on:click="sow_field(id, sow_field_type[id], sow_field_quantity[id])">засеять</a>
                                <a href="#" v-show="field.crop && field.crop.period !== 'DIE'" class="btn btn-primary btn-sm" v-on:click="harvest_field(id)">собрать</a>
                                <a href="#" v-show="field.crop && field.crop.period === 'DIE'" class="btn btn-primary btn-sm" v-on:click="clear_field(id)">очистить</a>

                                <a href="#" v-show="field.status === 'buy'" class="btn btn-primary btn-sm" v-on:click="sell_field(id)">продать</a>
                                <a href="#" v-show="field.status === 'rent'" class="btn btn-primary btn-sm" v-on:click="unrent_field(id)">вернуть</a>
                            </div>
                        </div>
                    </div>
                </div>
            </div>
        </div>
        <div class="col-sm-3">
        </div>
    </div>
    <!--        <div-->
    <!--             class="modal fade show"-->
    <!--             id="modalCenter"-->
    <!--             tabindex="-1"-->
    <!--             role="dialog"-->
    <!--             aria-labelledby="modalCenterTitle"-->
    <!--             aria-hidden="true"-->
    <!--        >-->
    <!--            <div class="modal-dialog">-->
    <!--                <div class="modal-content">-->
    <!--                    <div class="modal-header">-->
    <!--                        <h5 class="modal-title" id="errorModalLabel">{{ errorTitle }}</h5>-->
    <!--                        <button type="button" class="btn-close" data-bs-dismiss="modal" aria-label="Close"></button>-->
    <!--                    </div>-->
    <!--                    <div class="modal-body">-->
    <!--                        {{ errorText }}-->
    <!--                    </div>-->
    <!--                    <div class="modal-footer">-->
    <!--                        <button type="button" class="btn btn-secondary" data-bs-dismiss="modal">ясно</button>-->
    <!--                    </div>-->
    <!--                </div>-->
    <!--            </div>-->
    <!--        </div>-->

    <div class="alert alert-danger" role="alert" v-show="errorText">
        {{ errorText }}
    </div>

</div>
</body>
</html>
<script>
    async function postData(url = '', data = {}) {
        // Default options are marked with *
        const response = await fetch(url, {
            method: 'POST', // *GET, POST, PUT, DELETE, etc.
            mode: 'cors', // no-cors, *cors, same-origin
            cache: 'no-cache', // *default, no-cache, reload, force-cache, only-if-cached
            credentials: 'same-origin', // include, *same-origin, omit
            headers: {
                'Content-Type': 'application/json'
                // 'Content-Type': 'application/x-www-form-urlencoded',
            },
            redirect: 'follow', // manual, *follow, error
            referrerPolicy: 'no-referrer', // no-referrer, *client
            body: JSON.stringify(data) // body data type must match "Content-Type" header
        });
        return await response.json(); // parses JSON response into native JavaScript objects
    }
    async function update() {
        const data = await postData('/get_update');
        // console.log('data', data);
        if (data.error) this.startErrorModal(data.error);
        this.day = data.currentDay;
        this.year = data.currentYear;
        this.temp = data.temp;
        this.balance = data.balance;
        this.entities = data.entities;
        this.user = data.user;
    }

    new Vue({
        el: '#app',
        data: {
            additional_tab: 'fields',
            additional_shop_tab: 'fields',
            additional_warehouse_tab: 'harvest',
            seeds_shop: {},
            sow_field_type: [],
            sow_field_quantity: [],
            errorTitle: 'ОШИБКА',
            errorText: null,
            day: null,
            year: null,
            temp: null,
            balance: 0,
            entities: {},
            user: { warehouse: { seeds: {}, harvest: {}} },
            showModal: true,
            plant: {}
        },
        async beforeMount(){
            await this.update();
            this.update_fields_values();
            setInterval(async () => {
                this.update();
            }, 1000);
        },
        methods: {
            _: function(text) {
                const lang = {
                    wheat: 'пишеничка',
                    barley: 'ячмень'
                };
                return lang[text];
            },
            update,
            update_fields_values: function () {
                this.entities.fields.forEach((field, id) => {
                    if(field.owner === this.user._id) {
                        this.sow_field_quantity[id] = field.size;
                        this.sow_field_type[id] = 'wheat';
                    }
                });
            },
            startErrorModal: function (text) {
                this.errorText = text;
                setTimeout(() => { this.errorText = null; },3000)
            },
            rent_field: async function (id) {

                const data = await postData('/field/rent', { id });
                console.log('data', data);
                if (data.error) this.startErrorModal(data.error);
            },

            buy_field: async function (id) {

                const data = await postData('/field/buy', { id });
                console.log('data', data);
                if (data.error) this.startErrorModal(data.error);
            },

            sell_field: async function (id) {
                const data = await postData('/field/sell', { id });
                console.log('data', data);
                if (data.error) this.startErrorModal(data.error);
            },

            sow_field: async function (id, seedType, quantity) {
                const data = await postData('/field/sow', { id, seedType, quantity });
                console.log('data', data);
                if (data.error) this.startErrorModal(data.error);
            },

            harvest_field: async function (id) {
                const data = await postData('/field/harvest', { id });
                console.log('data', data);
                if (data.error) this.startErrorModal(data.error);
            },

            unrent_field: async function (id) {
                const data = await postData('/field/unrent', { id });
                console.log('data', data);
                if (data.error) this.startErrorModal(data.error);
            },

            clear_field: async function (id) {
                const data = await postData('/field/clear', { id });
                console.log('data', data);
                if (data.error) this.startErrorModal(data.error);
            },

            sell_harvest: async function (harvestType) {
                const data = await postData('/harvest/sell', { harvestType });
                console.log('data', data);
                if (data.error) this.startErrorModal(data.error);
            },

            buy_seeds: async function (seedType, quantity) {

                if (!quantity) return;
                const data = await postData('/seeds/buy', { seedType, quantity });
                console.log('data', data);
                if (data.error) this.startErrorModal(data.error);
            },

            update4: function () {
                this.message = `Updated at ${Date.now()}`
            },
        }
    });
</script>

